# Implementation Plan: Polling Service

**Branch**: `004-polling-service` | **Date**: 2025-12-23 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/004-polling-service/spec.md`

## Summary

EventEmitter-based PollingService for periodic collection of PostgreSQL replication monitoring data. Executes parallel queries across healthy nodes via ConnectionManager, emitting typed events for replication stats, subscriptions, slots, and conflicts. Supports configurable intervals (minimum 250ms), start/stop lifecycle control with immediate poll on start, and per-node pglogical detection.

## Technical Context

**Language/Version**: TypeScript 5.7 (strict mode)
**Primary Dependencies**: Node.js EventEmitter, ConnectionManager (003-connection-management), pg (^8.x)
**Storage**: N/A (queries PostgreSQL nodes via ConnectionManager, no local storage)
**Testing**: Bun test, ink-testing-library for integration
**Target Platform**: Node.js 18+ / Bun
**Project Type**: single
**Performance Goals**: Poll cycle completes in <2x single-node query time for 10 nodes; events emitted within 50ms of configured interval
**Constraints**: Minimum 250ms polling interval; no overlapping query cycles; query timeout handled by ConnectionManager (30s default)
**Scale/Scope**: Support 1-20+ nodes without performance degradation

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Component-First Architecture | N/A | PollingService is a service, not UI. UI components will subscribe to events. |
| II. Type Safety (NON-NEGOTIABLE) | PASS | All event payloads, query results, and config will be fully typed. No `any` types. |
| III. Real-Time Reactive State | PASS | PollingService emits events at 1s default interval; UI derives from Zustand store via event handlers (separate integration). |
| IV. Keyboard-First UX | N/A | Service layer, no direct UI interaction. |
| V. PostgreSQL Compatibility | PASS | Per-node pglogical detection (FR-005a); queries for native replication (v10+) and pglogical. |
| VI. Fail-Safe Operations | PASS | Partial results on node failure (FR-008); errors surfaced via error events (FR-011). |
| VII. Complete Implementation (NON-NEGOTIABLE) | PASS | Full implementation of all 17 FRs required; no placeholders or stubs. |

**Gate Result**: PASS - No violations. Proceed to Phase 0.

## Project Structure

### Documentation (this feature)

```text
specs/004-polling-service/
├── plan.md              # This file
├── research.md          # PostgreSQL query research from local repos
├── data-model.md        # Entity definitions and relationships
├── quickstart.md        # Usage examples
├── contracts/           # TypeScript interfaces
│   └── polling-service.ts
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (repository root)

```text
src/
├── services/
│   ├── connection-manager/   # Existing (003-connection-management)
│   │   ├── index.ts
│   │   ├── types.ts
│   │   ├── events.ts
│   │   ├── pool-factory.ts
│   │   └── health-checker.ts
│   └── polling/              # NEW (this feature)
│       ├── index.ts          # PollingService class export
│       ├── types.ts          # Event types, data types, config
│       ├── queries/          # SQL query modules
│       │   ├── index.ts      # Query aggregator
│       │   ├── stats.ts      # Replication stats queries
│       │   ├── subscriptions.ts  # Subscription queries
│       │   ├── slots.ts      # Replication slot queries
│       │   └── conflicts.ts  # Conflict queries
│       └── pglogical-detector.ts  # Per-node pglogical detection
└── types/
    └── polling.ts            # Re-export polling types for convenience

tests/
├── unit/
│   └── services/
│       └── polling/
│           ├── polling-service.test.ts
│           ├── pglogical-detector.test.ts
│           └── queries/
│               ├── stats.test.ts
│               ├── subscriptions.test.ts
│               ├── slots.test.ts
│               └── conflicts.test.ts
└── integration/
    └── polling-service.integration.test.ts
```

**Structure Decision**: Single project structure following existing pattern from connection-manager. Service lives in `src/services/polling/` with modular query files for maintainability.

## Active Technologies

- TypeScript 5.7 (strict mode) + Node.js EventEmitter, pg (^8.x), existing ConnectionManager (003-connection-management)
- PostgreSQL 10+ (pg_stat_replication, pg_replication_slots, pg_stat_subscription)
- PostgreSQL 16+ (pg_stat_subscription_stats for native conflict tracking)
- pglogical 2.x (optional, detected per-node at runtime)

## Research Summary

See [research.md](./research.md) for complete query documentation.

**Key Findings**:
1. **Lag calculation**: `pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn)` for bytes, `EXTRACT(EPOCH FROM replay_lag)` for seconds
2. **WAL retention**: `pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)` per slot
3. **pglogical detection**: Check `pg_extension` table for `extname = 'pglogical'`
4. **Conflict tracking**: Native only in PG16+ via `pg_stat_subscription_stats`; pglogical logs to server log only (not queryable)

## Artifacts Generated

- [research.md](./research.md) - SQL queries from postgres/pglogical source
- [data-model.md](./data-model.md) - Entity definitions
- [contracts/polling-service.ts](./contracts/polling-service.ts) - TypeScript interfaces
- [quickstart.md](./quickstart.md) - Usage examples

## Implementation Status

**Status**: ✅ Implementation Complete (2025-12-23)

All 39 tasks completed across 8 phases:
- Phase 1 (Setup): Directory structure and types
- Phase 2 (Foundational): Query modules and pglogical detection
- Phase 3 (US1): Core polling service with event emission
- Phase 4 (US2): Configurable polling interval
- Phase 5 (US3): Start/stop lifecycle control
- Phase 6 (US4): Graceful error handling
- Phase 7 (US5): Multiple data type subscriptions
- Phase 8 (Polish): Validation and documentation
